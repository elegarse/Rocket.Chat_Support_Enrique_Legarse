function module(t,e,n){var a,i,r,s,o,l,u,c,v,m,f,g,d,h;n.link("@babel/runtime/helpers/toConsumableArray",{default:function(t){a=t}},0),n.link("@babel/runtime/regenerator",{default:function(t){i=t}},1),n.link("@babel/runtime/helpers/objectSpread2",{default:function(t){r=t}},2),n.link("@babel/runtime/helpers/objectWithoutProperties",{default:function(t){s=t}},3),n.link("meteor/meteor",{Meteor:function(t){o=t}},0),n.link("meteor/reactive-var",{ReactiveVar:function(t){l=t}},1),n.link("meteor/templating",{Template:function(t){u=t}},2),n.link("toastr",{default:function(t){c=t}},3),n.link("../../../../../utils",{t:function(t){v=t}},4),n.link("../../../../../authorization",{hasAtLeastOnePermission:function(t){m=t},hasPermission:function(t){f=t},hasRole:function(t){g=t}},5),n.link("./visitorEdit.html"),n.link("../../../../../utils/client",{APIClient:function(t){d=t}},6),n.link("../customTemplates/register",{getCustomFormTemplate:function(t){h=t}},7);var p=100,b=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0;return t.filter((function(t){var e=t.visibility,a=t.scope;return"hidden"!==e&&a===n})).map((function(t){var n=t._id,i=t.scope,o=t.label,l=s(t,["_id","scope","label"]),u=e[n]?e[n]:"";return r({name:n,label:o,scope:i,value:u,disabled:a},l)}))},T=function(){return!f("edit-livechat-room-customfields")};u.visitorEdit.helpers({visitor:function(){return u.instance().visitor.get()},canViewCustomFields:function(){return m(["view-livechat-room-customfields","edit-livechat-room-customfields"])},visitorCustomFields:function(){var t=u.instance().customFields.get();if(!t||0===t.length)return[];var e,n,a=(u.instance().visitor.get()||{}).livechatData,i;return b(t,void 0===a?{}:a,"visitor",T())},room:function(){return u.instance().room.get()},roomCustomFields:function(){var t=u.instance().customFields.get();if(!t||0===t.length)return[];var e,n,a=(u.instance().room.get()||{}).livechatData,i;return b(t,void 0===a?{}:a,"room",T())},email:function(){var t=u.instance().visitor.get();if(t.visitorEmails&&t.visitorEmails.length>0)return t.visitorEmails[0].address},phone:function(){var t=u.instance().visitor.get();if(t.phone&&t.phone.length>0)return t.phone[0].phoneNumber},tags:function(){return u.instance().tags.get()},availableUserTags:function(){return u.instance().availableUserTags.get()},hasAvailableTags:function(){var t=u.instance().availableTags.get();return t&&t.length>0},canRemoveTag:function(t,e){return g(o.userId(),["admin","livechat-manager"])||Array.isArray(t)&&(0===t.length||t.indexOf(e)>-1)},isSmsIntegration:function(){var t=u.instance().room.get();return!(!t||!t.sms)},customFieldsTemplate:function(){return h("livechatVisitorEditForm")}}),u.visitorEdit.onCreated(function(){function t(){var t=this,e,n,a,r,s;return i.async(function(){function c(c){for(;;)switch(c.prev=c.next){case 0:return this.visitor=new l,this.room=new l,this.tags=new l([]),this.availableTags=new l([]),this.agentDepartments=new l([]),this.availableUserTags=new l([]),this.customFields=new l([]),this.autorun(function(){function e(){var e,n,a,r;return i.async(function(){function s(s){for(;;)switch(s.prev=s.next){case 0:if(e=u.currentData(),!(n=e.visitorId)){s.next=7;break}return s.next=4,i.awrap(d.v1.get("livechat/visitors.info?visitorId="+n));case 4:a=s.sent,r=a.visitor,t.visitor.set(r);case 7:case"end":return s.stop()}}return s}(),null,null,null,Promise)}return e}()),e=u.currentData().roomId,this.autorun(function(){function n(){var n,a,r,s;return i.async(function(){function o(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,i.awrap(d.v1.get("rooms.info?roomId="+e));case 2:return n=o.sent,a=n.room,o.next=6,i.awrap(d.v1.get("livechat/custom-fields?count="+p));case 6:r=o.sent,s=r.customFields,t.room.set(a),t.tags.set(a&&a.tags||[]),t.customFields.set(s||[]);case 11:case"end":return o.stop()}}return o}(),null,null,null,Promise)}return n}()),n=o.userId(),c.next=13,i.awrap(d.v1.get("livechat/agents/"+n+"/departments"));case 13:a=c.sent,r=a.departments,s=r.map((function(t){return t.departmentId})),this.agentDepartments.set(s),o.call("livechat:getTagsList",(function(e,a){t.availableTags.set(a);var i=t.agentDepartments.get(),r=g(n,["admin","livechat-manager"]),s,o=(t.availableTags.get()||[]).filter((function(t){var e=t.departments;return r||0===e.length||e.some((function(t){return i.indexOf(t)>-1}))})).map((function(t){var e;return t.name}));t.availableUserTags.set(o)}));case 18:case"end":return c.stop()}}return c}(),null,this,null,Promise)}return t}()),u.visitorEdit.events({"submit form":function(t,e){var n=this;t.preventDefault();var a={_id:e.visitor.get()._id},i=e.room.get(),r=i._id,s=i.sms,l={_id:r};a.name=t.currentTarget.elements.name.value,a.email=t.currentTarget.elements.email.value,a.phone=t.currentTarget.elements.phone.value,a.livechatData={},$("[data-visitorLivechatData=true]").each((function(){a.livechatData[this.name]=$(this).val()||""})),l.topic=t.currentTarget.elements.topic.value,l.tags=e.tags.get(),l.livechatData={},$("[data-roomLivechatData=true]").each((function(){l.livechatData[this.name]=$(this).val()||""})),s&&delete a.phone,e.$(".customFormField").each((function(t,n){var a=e.$(n),i=a.attr("name");l[i]=a.val()})),o.call("livechat:saveInfo",a,l,(function(t){t?c.error(v(t.error)):(c.success(v("Saved")),n.save())}))},"click .remove-tag":function(t,e){var n=this.valueOf(),a=e.availableTags.get(),i=a&&a.length>0,r=e.availableUserTags.get();if(g(o.userId(),["admin","livechat-manager"])||!i||r&&-1!==r.indexOf(n)){t.stopPropagation(),t.preventDefault();var s=e.tags.get();s=s.filter((function(t){return t!==n})),e.tags.set(s)}},"click #addTag":function(t,e){if(t.stopPropagation(),t.preventDefault(),!$("#tagSelect").find(":selected").is(":disabled")){var n=a(e.tags.get()),i=$("#tagSelect").val();""===i||n.indexOf(i)>-1||(n.push(i),e.tags.set(n),$("#tagSelect").val("placeholder"))}},"keydown #tagInput":function(t,e){if(13===t.which){t.stopPropagation(),t.preventDefault();var n=a(e.tags.get()),i=$("#tagInput").val();if(""===i||n.indexOf(i)>-1)return;n.push(i),e.tags.set(n),$("#tagInput").val("")}},"click .cancel":function(){this.cancel()}})}

