function module(e,t,n){var a,r,s,i,o,l,u,c,g,f,m,h,d,p,v,T,b,C;n.link("@babel/runtime/helpers/objectSpread2",{default:function(e){a=e}},0),n.link("@babel/runtime/helpers/slicedToArray",{default:function(e){r=e}},1),n.link("@babel/runtime/regenerator",{default:function(e){s=e}},2),n.link("@babel/runtime/helpers/toConsumableArray",{default:function(e){i=e}},3),n.link("meteor/meteor",{Meteor:function(e){o=e}},0),n.link("meteor/reactive-var",{ReactiveVar:function(e){l=e}},1),n.link("meteor/kadira:flow-router",{FlowRouter:function(e){u=e}},2),n.link("meteor/templating",{Template:function(e){c=e}},3),n.link("underscore",{default:function(e){g=e}},4),n.link("toastr",{default:function(e){f=e}},5),n.link("../../../../ui-utils",{TabBar:function(e){m=e},RocketChatTabBar:function(e){h=e}},6),n.link("../../../../utils",{t:function(e){d=e},handleError:function(e){p=e}},7),n.link("../../../../authorization",{hasPermission:function(e){v=e}},8),n.link("./customTemplates/register",{getCustomFormTemplate:function(e){T=e}},9),n.link("./livechatDepartmentForm.html"),n.link("../../../../utils/client",{APIClient:function(e){b=e},roomTypes:function(e){C=e}},10);var w=50,k=function(){function e(e,t){var n,a;return s.async(function(){function r(r){for(;;)switch(r.prev=r.next){case 0:if(n=i(t.agentsToUpsert.values()),a=i(t.agentsToRemove.values()),n.length||a.length){r.next=4;break}return r.abrupt("return");case 4:return r.abrupt("return",b.v1.post("livechat/department/"+e+"/agents",{upsert:n,remove:a}));case 5:case"end":return r.stop()}}return r}(),null,null,null,Promise)}return e}();c.livechatDepartmentForm.helpers({department:function(){return c.instance().department.get()},agents:function(){return c.instance().department&&!g.isEmpty(c.instance().department.get())?c.instance().department.get().agents:[]},departmentAgents:function(){return g.sortBy(c.instance().departmentAgents.get(),"username")},showOnRegistration:function(e){var t=c.instance().department.get();return t.showOnRegistration===e||void 0===t.showOnRegistration&&!0===e},showOnOfflineForm:function(e){var t=c.instance().department.get();return t.showOnOfflineForm===e||void 0===t.showOnOfflineForm&&!0===e},requestTagBeforeClosingChat:function(){var e=c.instance().department.get();return!(!e||!e.requestTagBeforeClosingChat)},customFieldsTemplate:function(){return T("livechatDepartmentForm")},data:function(){return{id:u.getParam("_id")}},exceptionsAgents:function(){return g.pluck(c.instance().departmentAgents.get(),"username")},agentModifier:function(){return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=e.get();return"@"+(0===n.length?t:t.replace(new RegExp(e.get()),(function(e){return"<strong>"+e+"</strong>"})))}},agentConditions:function(){return{roles:"livechat-agent"}},onSelectAgents:function(){return c.instance().onSelectAgents},selectedAgents:function(){return c.instance().selectedAgents.get()},onClickTagAgents:function(){return c.instance().onClickTagAgents},flexData:function(){return{tabBar:c.instance().tabBar,data:c.instance().tabBarData.get()}},tabBarVisible:function(){return Object.values(m.buttons.get()).some((function(e){return e.groups.some((function(e){return e.startsWith("livechat-department")}))}))},chatClosingTags:function(){return c.instance().chatClosingTags.get()},availableDepartmentTags:function(){return c.instance().availableDepartmentTags.get()},hasAvailableTags:function(){return i(c.instance().availableTags.get()).length>0},hasChatClosingTags:function(){return i(c.instance().chatClosingTags.get()).length>0},onTableScroll:function(){var e=c.instance();return function(t){if(!(t.offsetHeight+t.scrollTop<t.scrollHeight-100)){var n=e.departmentAgents.get();e.total.get()>n.length&&e.offset.set(e.offset.get()+w)}}},onClickTagOfflineMessageChannel:function(){return c.instance().onClickTagOfflineMessageChannel},selectedOfflineMessageChannel:function(){return c.instance().offlineMessageChannel.get()},onSelectOfflineMessageChannel:function(){return c.instance().onSelectOfflineMessageChannel},offlineMessageChannelModifier:function(){return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=e.get();return"#"+(0===n.length?t:t.replace(new RegExp(e.get()),(function(e){return"<strong>"+e+"</strong>"})))}},channelSelector:function(){return function(e){return{name:e}}}}),c.livechatDepartmentForm.events({"submit #department-form":function(e,t){e.preventDefault();var n=t.$("button.save"),a,i=$(e.currentTarget).data("id");if(v("manage-livechat-departments")){var l=t.$("input[name=enabled]:checked").val(),c=t.$("input[name=name]").val(),g=t.$("textarea[name=description]").val(),m=t.$("input[name=showOnRegistration]:checked").val(),h=t.$("input[name=email]").val(),T=t.$("input[name=showOnOfflineForm]:checked").val(),b=t.$("input[name=requestTagBeforeClosingChat]:checked").val(),w=t.chatClosingTags.get(),A=t.offlineMessageChannel.get(),x,O=r(A,1)[0],_=O&&C.getRoomName(O.t,O)||"";if("1"!==l&&"0"!==l)return f.error(d("Please_select_enabled_yes_or_no"));if(""===c.trim())return f.error(d("Please_fill_a_name"));if(""===h.trim()&&"1"===T)return f.error(d("Please_fill_an_email"));a={enabled:"1"===l,name:c.trim(),description:g.trim(),showOnRegistration:"1"===m,showOnOfflineForm:"1"===T,requestTagBeforeClosingChat:"1"===b,email:h.trim(),chatClosingTags:w,offlineMessageChannelName:_}}var M=n.html();if(n.html(d("Saving")),t.$(".customFormField").each((function(e,n){var r=t.$(n),s=r.attr("name");a[s]=r.val()})),v("manage-livechat-departments"))o.call("livechat:saveDepartment",i,a,[],function(){function e(e,a){return s.async(function(){function r(r){for(;;)switch(r.prev=r.next){case 0:if(n.html(M),!e){r.next=3;break}return r.abrupt("return",p(e));case 3:return r.next=5,s.awrap(k(a._id,t));case 5:f.success(d("Saved")),u.go("livechat-departments");case 7:case"end":return r.stop()}}return r}(),null,null,null,Promise)}return e}());else{if(!v("add-livechat-department-agents"))throw new Error(d("error-not-authorized"));k(i,t)}},"click .add-agent":function(e,t){var n;e.preventDefault(),t.selectedAgents.get().forEach(function(){function e(e){var n,r,i,o;return s.async(function(){function s(s){for(;;)switch(s.prev=s.next){case 0:if(n=e._id,r=e.username,!(i=t.departmentAgents.get()).find((function(e){var t;return e.agentId===n}))){s.next=4;break}return s.abrupt("return",f.error(d("This_agent_was_already_selected")));case 4:(o=g.clone(e)).agentId=n,delete o._id,t.agentsToRemove.has(o.agentId)&&t.agentsToRemove.delete(o.agentId),t.agentsToUpsert.set(o.agentId,a({},o,{count:0,order:0})),i.push(o),t.departmentAgents.set(i),t.selectedAgents.set(t.selectedAgents.get().filter((function(e){return e.username!==r})));case 12:case"end":return s.stop()}}return s}(),null,null,null,Promise)}return e}())},"click button.back":function(e){e.preventDefault(),u.go("livechat-departments")},"click .remove-agent":function(e,t){var n=this;e.preventDefault(),t.agentsToUpsert.has(this.agentId)&&t.agentsToUpsert.delete(this.agentId),t.agentsToRemove.set(this.agentId,this),t.departmentAgents.set(t.departmentAgents.get().filter((function(e){return e.agentId!==n.agentId})))},"keyup .count":function(e,t){var n=t.agentsToUpsert.get(this.agentId)||this;t.agentsToUpsert.set(this.agentId,a({},n,{count:parseInt(e.currentTarget.value)||0}))},"keyup .order":function(e,t){var n=t.agentsToUpsert.get(this.agentId)||this;t.agentsToUpsert.set(this.agentId,a({},n,{order:parseInt(e.currentTarget.value)||0}))},"click #addTag":function(e,t){e.stopPropagation(),e.preventDefault();var n=i(t.availableTags.get()).length>0,a=n?"#tagSelect":"#tagInput",r=n?"placeholder":"",s=$(a).val(),o=i(t.chatClosingTags.get());""===s||o.indexOf(s)>-1||(o.push(s),t.chatClosingTags.set(o),$(a).val(r))},"click .remove-tag":function(e,t){var n=this;e.stopPropagation(),e.preventDefault();var a=i(t.chatClosingTags.get()).filter((function(e){return e!==n.valueOf()}));t.chatClosingTags.set(a)}}),c.livechatDepartmentForm.onCreated(function(){function e(){var e=this;return s.async(function(){function t(t){for(;;)switch(t.prev=t.next){case 0:this.agentsToUpsert=new Map,this.agentsToRemove=new Map,this.department=new l({enabled:!0}),this.departmentAgents=new l([]),this.selectedAgents=new l([]),this.tabBar=new h,this.tabBar.showGroup(u.current().route.name),this.tabBarData=new l,this.chatClosingTags=new l([]),this.availableTags=new l([]),this.availableDepartmentTags=new l([]),this.offset=new l(0),this.total=new l(0),this.offlineMessageChannel=new l([]),this.onClickTagOfflineMessageChannel=function(){e.offlineMessageChannel.set([])},this.onSelectOfflineMessageChannel=function(){function t(t){var n,a,r;return s.async(function(){function i(i){for(;;)switch(i.prev=i.next){case 0:return n=t.item,i.next=3,s.awrap(b.v1.get("rooms.info?roomId="+n._id));case 3:a=i.sent,(r=a.room).text=r.name,e.offlineMessageChannel.set([r]);case 7:case"end":return i.stop()}}return i}(),null,null,null,Promise)}return t}(),this.onSelectAgents=function(t){var n=t.item;e.selectedAgents.set([n])},this.onClickTagAgents=function(t){var n=t.username;e.selectedAgents.set(e.selectedAgents.get().filter((function(e){return e.username!==n})))},this.loadAvailableTags=function(t){o.call("livechat:getTagsList",(function(n,a){e.availableTags.set(a||[]);var r,s=e.availableTags.get().filter((function(e){var n=e.departments;return 0===n.length||n.indexOf(t)>-1})).map((function(e){var t;return e.name}));e.availableDepartmentTags.set(s)}))},this.autorun(function(){function t(){var t,n,a,r;return s.async(function(){function i(i){for(;;)switch(i.prev=i.next){case 0:return t=e.offset.get(),i.next=3,s.awrap(b.v1.get("livechat/department/"+u.getParam("_id")+"/agents?count="+w+"&offset="+t));case 3:n=i.sent,a=n.agents,r=n.total,e.total.set(r),0===t?e.departmentAgents.set(a):e.departmentAgents.set(e.departmentAgents.get().concat(a));case 8:case"end":return i.stop()}}return i}(),null,null,null,Promise)}return t}()),this.autorun(function(){function t(){var t,n,a;return s.async(function(){function r(r){for(;;)switch(r.prev=r.next){case 0:if(!(t=u.getParam("_id"))){r.next=9;break}return r.next=4,s.awrap(b.v1.get("livechat/department/"+u.getParam("_id")+"?includeAgents=false"));case 4:n=r.sent,a=n.department,e.department.set(a),e.chatClosingTags.set(a&&a.chatClosingTags||[]),e.loadAvailableTags(t);case 9:case"end":return r.stop()}}return r}(),null,null,null,Promise)}return t}()),this.autorun(function(){function t(){var t,n,r,i;return s.async(function(){function o(o){for(;;)switch(o.prev=o.next){case 0:if(t=e.department.get(),n=[],!(null==t?void 0:t.offlineMessageChannelName)){o.next=8;break}return o.next=5,s.awrap(b.v1.get("rooms.info?roomName="+(null==t?void 0:t.offlineMessageChannelName)));case 5:r=o.sent,(i=r.room)&&(i.text=i.name,n=[a({},i)]);case 8:e.offlineMessageChannel.set(n);case 9:case"end":return o.stop()}}return o}(),null,null,null,Promise)}return t}());case 22:case"end":return t.stop()}}return t}(),null,this,null,Promise)}return e}())}

